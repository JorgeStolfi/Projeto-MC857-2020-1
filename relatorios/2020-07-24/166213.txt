
Diagnóstico inicial: o acréscimo de dados para depuração provoca o erro na página de alteração de dados de uma compra.
É possível fazer com que a alteração de uma compra funcione se o trecho a seguir do arquivo processa_comando_http_IMP.py for comentado:

593:  if mostra_cmd:
594:     # Acrescenta os dados para depuração:
595:     pag = re.sub(r'</body>', ("<br/>%s<br/><br/></body>" % formata_dados_http(cmd,args,dados)), pag)

Este trecho injeta o código de depuração a cada comando processado e utiliza a biblioteca do Python para 
expressões regulares re.py, presente na versão 3.8 do Python na minha máquina Linux.

Aparentemente, o erro ocorre devido a um character de escape incorreto (do tipo unicode), já que o traceback reporta:



Exception happened during processing of request from ('127.0.0.1', 47368)
Traceback (most recent call last):
  File "/usr/lib/python3.8/sre_parse.py", line 1039, in parse_template
    this = chr(ESCAPES[this][1])
KeyError: '\\u'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/lib/python3.8/socketserver.py", line 316, in _handle_request_noblock
    self.process_request(request, client_address)
  File "/usr/lib/python3.8/socketserver.py", line 347, in process_request
    self.finish_request(request, client_address)
  File "/usr/lib/python3.8/socketserver.py", line 360, in finish_request
    self.RequestHandlerClass(request, client_address, self)
  File "/usr/lib/python3.8/socketserver.py", line 720, in __init__
    self.handle()
  File "/usr/lib/python3.8/http/server.py", line 427, in handle
    self.handle_one_request()
  File "/usr/lib/python3.8/http/server.py", line 415, in handle_one_request
    method()
  File "/home/daniel/mc857/Projeto-MC857-2020-1/processa_comando_http_IMP.py", line 86, in do_GET
    return self.do_geral('GET')
  File "/home/daniel/mc857/Projeto-MC857-2020-1/processa_comando_http_IMP.py", line 121, in do_geral
    pag, ses_nova = processa_comando(tipo, ses, dados)
  File "/home/daniel/mc857/Projeto-MC857-2020-1/processa_comando_http_IMP.py", line 595, in processa_comando
    pag = re.sub(r'</body>', ("<br/>%s<br/><br/></body>" % formata_dados_http(cmd,args,dados)), pag)
  File "/usr/lib/python3.8/re.py", line 208, in sub
    return _compile(pattern, flags).sub(repl, string, count)
  File "/usr/lib/python3.8/re.py", line 325, in _subx
    template = _compile_repl(template, pattern)
  File "/usr/lib/python3.8/re.py", line 316, in _compile_repl
    return sre_parse.parse_template(repl, pattern)
  File "/usr/lib/python3.8/sre_parse.py", line 1042, in parse_template
    raise s.error('bad escape %s' % this, len(this))
re.error: bad escape \u at position 614 (line 10, column 29)



O próximo passo será descobrir se o erro é provocado pela chamada 

formata_dados_http(cmd,args,dados)

ou, por outro lado, se a página devolvida com os dados da alteração está incorreta.
A primeira hipotese é mais provável, porque a página com os dados da alteração é renderizada sem erros
quando o trecho do código que mostra as informações de depuração é comentado, como dito no início deste
relatório.

A função formata_dados_http(cmd,args,dados) é invocada para diversos comandos sem apresentar problema.
Portanto, é provável que ela esteja sendo chamada com erro nos argumentos no caso do comando alterar_compra.
Por falta de tempo hábil, não será possível continuar a análise.



